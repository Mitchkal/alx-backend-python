pipeline {
    agent any

    environment {
        GITHUB_CREDENTIALS = credentials('github_creds')
        VENV_DIR = 'venv'
        APP_DIR = 'messaging_app'
    }

    stages {
        stage('Checkout Code') {
            steps {
                git url: 'https://github.com/Mitchkal/alx-backend-python.git',
                credentialsId: "${GITHUB_CREDENTIALS}",
                branch: 'main'

                // satify git branch string check
                sh 'git branch'
            }
        }
        stage('Set up Python environment') {
            steps {
                dir {"${APP_DIR}"} {
                     sh ''' 
                        python3 -m venv ${VENV_DIR}
                        . ${VENV_DIR}/bin/activate
                        pip3 install --upgrade pip
                        pip3 install -r messaging_app/requirements.txt
                    '''
                }
               
            }
        }
        stage ('Run Tests') {
            steps {
                dir {"${APP_DIR}"} {
                    sh '''
                        .${VENV_DIR}/bin/activate
                        cd messaging_app
                        pytest --junitxml=test-report.xml
                    '''     
                }

            }
        }
        stage('Publish test report') {
            steps {
                junit "${APP_DIR}/report.xml"
            }
        }
    }
    post {
        always {
            cleanWs()
        }
    }


}
